<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ImgTC | Admin</title>
  <!-- Import CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/theme-chalk/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <script src="https://js.sentry-cdn.com/219f636ac7bde5edab2c3e16885cb535.min.js" crossorigin="anonymous"></script>
  <!-- Plyr 播放器 -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  <style>
    body {
      background: linear-gradient(90deg, #ffd7e4 0%, #c8f1ff 100%);
      font-family: 'Arial', sans-serif;
      color: #333;
      margin: 0;
      padding: 0;
    }

    .header-content {
      position: fixed;
      top: 0;
      left: 1%;
      right: 1%;
      z-index: 999;
      height: clamp(40px, 8vh, 60px);
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background-color: rgba(255, 255, 255, 0.75);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: background-color 0.5s ease, box-shadow 0.5s ease;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }

    .header-content:hover {
      background-color: rgba(255, 255, 255, 0.85);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
    }

    .title {
      font-size: clamp(1.2em, 2vw, 1.8em);
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
      margin-right: 4px;
      color: #333;
    }

    .title:hover {
      color: #B39DDB; /* 使用柔和的淡紫色 */
    }

    .search-card {
      margin-left: auto;
      margin-right: 16px;
    }

    .stats {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: clamp(0.9em, 1.5vw, 1.2em);
      background: rgba(255, 255, 255, 0.9);
      margin-right: 8px;
      padding: 2px 8px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
      color: #333;
    }

    .stats:hover {
      background-color: #f0eaf8; /* 柔和的淡紫色 */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: scale(1.02);
      color: #B39DDB;
    }

    /* 上传图标样式优化 */
    .upload-icon {
      margin-right: 10px;
      font-size: clamp(1.2em, 1.5vw, 1.6em);
      transition: color 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
      color: inherit;
      cursor: pointer;
      border-radius: 50%;
      padding: 8px;
      background-color: rgba(179, 157, 219, 0.15); /* 淡紫色的背景，与整体风格一致 */
      border: 1px solid transparent;
    }

    .header-content .actions {
      display: flex;
      align-items: center;
    }

    .header-content .actions i {
      font-size: clamp(1.2em, 1.5vw, 1.6em);
      cursor: pointer;
      transition: color 0.3s, transform 0.3s;
      color: #333;
      margin: 0 8px;
    }

    .header-content .actions i:hover {
      color: #B39DDB; /* 使用柔和的淡紫色 */
      transform: scale(1.1);
    }

    .header-content .actions .el-dropdown-link i {
      color: #333;
    }

    .header-content .actions .el-dropdown-link i:hover {
      color: #B39DDB; /* 使用柔和的淡紫色 */
    }

    .header-content .actions .disabled {
      color: #bbb;
      pointer-events: none;
    }

    .header-content .actions .enabled {
      color: #B39DDB; /* 使用柔和的淡紫色 */
    }

    .search-card .el-input__inner {
      border-radius: 20px;
      width: clamp(200px, 25vw, 300px);
      height: clamp(30px, 5vh, 40px);
      font-size: 1.2em;
      border: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: width 0.3s;
    }

    .search-card .el-input__inner:focus {
      width: clamp(250px, 30vw, 400px);
    }

    .main-container {
      display: flex;
      flex-direction: column;
      margin-top: 20px;
      padding: 20px;
      min-height: calc(100vh - 80px);
    }

    .content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      padding: 10px;
      flex-grow: 1;
    }

    .image-card {
      width: 100%;
      aspect-ratio: 4 / 3;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
      object-fit: cover;
      transition: transform 0.3s ease;
      border: none;
    }

    .image-card:hover {
      transform: scale(1.02);
      cursor: pointer;
    }

    .el-image {
      object-fit: cover;
      transition: opacity 0.3s ease;
    }

    .el-image:hover {
      opacity: 0.8;
    }

    .card-footer {
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      text-align: center;
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .el-card:hover .image-overlay {
      opacity: 1;
    }

    .overlay-buttons {
      display: flex;
      gap: 10px;
      pointer-events: auto;
    }

    .pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 16px;
    }

    .collect-icon {
      position: absolute;
      top: -1.3px;
      left: 10px;
      cursor: pointer;
      font-size: 1.5em;
      z-index: 10;
      transition: color 0.3s ease, transform 0.3s ease;
    }
    .collect-icon:hover {transform: scale(1.2);}
    .liked {color: #FFD7E4;}
    .not-liked {color: #b39edb80;}

    .el-checkbox {
      position: absolute;
      top: 10px;
      right: 10px;
      transform: scale(1.5);
      z-index: 10;
    }

    .footer {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 20px;
      font-size: 0.9em;
      color: #555; /* 字体颜色改为黑色 */
    }

    .footer a {
      color: #555; /* 链接颜色 */
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .footer a:hover {
      color: #333; /* 悬停时的链接颜色改为黑色 */
    }

    .footer i {
      color: #333; /* 图标颜色改为黑色 */
    }

    /* 适配移动端 */
    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr; /* 单列布局 */
        gap: 10px;
      }
      .header-content{padding: 8px 12px;}
      .stats, .actions i{margin: 0;}
      .el-card{aspect-ratio: unset; min-height: 180px;}
      .el-card__body{padding: 0;}
      .search-card {display: none;}
    }

    /* 音频卡片样式 */
    .audio-card {
      background: linear-gradient(135deg, #8a4bff 0%, #6d8eff 100%);
      border: none;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      justify-content: center;
      align-items: center;
      max-height: 480px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      height: 100%;
      width: 100%;
    }

    .audio-content {
      padding: 20px;
      color: white;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
      text-overflow: ellipsis;
      max-height: 480px;
    }

    .audio-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .audio-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px;
      margin-right: 15px;
    }

    .audio-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .audio-info {
      flex: 1;
      min-width: 0;
    }

    .audio-title {
      font-size: 16px;
      font-weight: 500;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .audio-artist {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    .audio-progress {
      margin: 20px 0;
    }

    .progress-bar {
      position: relative;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      cursor: pointer;
      margin-bottom: 8px;
    }

    .progress-handle {
      position: absolute;
      top: 50%;
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .progress-bar:hover .progress-handle,
    .progress-bar.dragging .progress-handle {
      opacity: 1;
    }

    .progress-track {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }

    .progress-current {
      position: absolute;
      height: 100%;
      background: white;
      border-radius: 2px;
      transition: width 0.1s linear;
    }

    .progress-handle {
      position: absolute;
      top: 50%;
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .progress-bar:hover .progress-handle {
      opacity: 1;
    }

    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    .audio-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .control-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .play-btn {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 50%;
      background: white;
      color: #8a4bff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .play-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .play-btn i {
      font-size: 18px;
      margin-left: 2px; /* 稍微调整播放图标的位置 */
    }

    .like-btn {
      color: white;
    }

    .like-btn .liked {
      color: #8a4bff;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    /* 移动端适配 */
    @media (max-width: 768px) {
      .audio-content {
        padding: 15px;
      }

      .audio-controls {
        gap: 15px;
      }

      .control-btn {
        width: 32px;
        height: 32px;
      }

      .play-btn {
        width: 42px;
        height: 42px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <el-container>
      <el-header>
        <div class="header-content">
          <span class="title" @click="refreshDashboard">Dashboard</span>
          <div class="search-card">
            <el-input v-model="search" size="mini" placeholder="输入关键字搜索"></el-input>
          </div>
          <el-tooltip content="批量上传" placement="bottom">
              <span class="stats" @click="handleUpload">
                <i class="fas fa-upload upload-icon"></i>记录数: {{ Number }}
              </span>
          </el-tooltip>
          <input type="file" ref="fileInput" style="display: none;" multiple @change="uploadFiles">
          <div class="actions">
            <el-tooltip content="文件类型" placement="bottom">
              <el-dropdown @command="switchFileType" :hide-on-click="false">
                <span class="el-dropdown-link">
                  <i :class="fileTypeIcon"></i>
                </span>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item command="image" :class="{ 'el-dropdown-menu__item--selected': fileType === 'image' }">
                    <i class="fas fa-image"></i> 图片
                  </el-dropdown-item>
                  <el-dropdown-item command="video" :class="{ 'el-dropdown-menu__item--selected': fileType === 'video' }">
                    <i class="fas fa-video"></i> 视频
                  </el-dropdown-item>
                  <el-dropdown-item command="audio" :class="{ 'el-dropdown-menu__item--selected': fileType === 'audio' }">
                    <i class="fas fa-music"></i> 音频
                  </el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </el-tooltip>
            <el-tooltip content="排序" placement="bottom">
              <el-dropdown @command="sort" :hide-on-click="false">
                <span class="el-dropdown-link">
                  <i :class="sortIcon"></i>
                </span>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item command="dateDesc" :class="{ 'el-dropdown-menu__item--selected': sortOption === 'dateDesc' }">按时间倒序</el-dropdown-item>
                  <el-dropdown-item command="nameAsc" :class="{ 'el-dropdown-menu__item--selected': sortOption === 'nameAsc' }">按名称升序</el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </el-tooltip>
            <el-tooltip content="收藏筛选" placement="bottom">
              <i class="fas fa-heart" :class="{ enabled: showFavorites }" @click="toggleFavorites"></i>
            </el-tooltip>
            <el-tooltip content="全选当前页" placement="bottom">
              <i class="fas fa-check-square" @click="selectAllInPage"></i>
            </el-tooltip>
            <el-tooltip content="批量复制" placement="bottom">
              <i class="fas fa-link" :class="{ disabled: selectedFiles.length === 0 }" @click="handleBatchCopy"></i>
            </el-tooltip>
            <el-tooltip content="批量删除" placement="bottom">
              <i class="fas fa-trash-alt" :class="{ disabled: selectedFiles.length === 0 }" @click="handleBatchDelete"></i>
            </el-tooltip>
            <el-tooltip content="检测失效图片" placement="bottom">
              <i class="fas fa-wrench" @click="checkBrokenImages"></i>
            </el-tooltip>
            <el-tooltip content="退出登录" placement="bottom">
              <i class="fas fa-home" @click="handleLogout"></i>
            </el-tooltip>
          </div>
        </div>
      </el-header>
      <el-main class="main-container">
        <div class="content">
          <template v-for="(item, index) in paginatedTableData" :key="index">
            <!-- 非音频文件 -->
            <el-card class="image-card" v-if="fileType !== 'audio'">
              <span class="collect-icon" @click.stop="toggleLike(index, item.name)">
                <i :class="item.metadata.liked ? 'fa-solid fa-bookmark liked' : 'fa-regular fa-bookmark not-liked'"></i>
              </span>
              <el-checkbox v-model="item.selected" :ref="'checkbox-' + index"></el-checkbox>
              <template v-if="fileType === 'image'">
                <el-image
                  :src="'/file/' + item.name"
                  :preview-src-list="['/file/' + item.name]"
                  fit="cover"
                  lazy="true"
                ></el-image>
              </template>
              <template v-else-if="fileType === 'video'">
                <video
                  :src="'/file/' + item.name"
                  controls
                  style="width: 100%; height: 100%; object-fit: cover;"
                ></video>
              </template>
              <div class="image-overlay">
                <div class="overlay-buttons">
                  <el-button size="mini" type="primary" @click.stop="handleCopy(index, item.name)">复制地址</el-button>
                  <el-button size="mini" type="danger" @click.stop="handleDelete(index, item.name)">删除</el-button>
                </div>
              </div>
              <div class="card-footer">{{ item.name }}</div>
            </el-card>
            <el-card v-else class="audio-card" :class="{ 'selected': item.selected }" @click="toggleSelect(index)">
              <!-- 音频内容区域 -->
              <div class="audio-content">
                <!-- 音频标题和时长 -->
                <div class="audio-header">
                  <div class="audio-avatar">
                    <img src="/static/music.png" alt="Music">
                  </div>
                  <div class="audio-info">
                    <div class="audio-title">{{ item.name }}</div>
                    <div class="audio-subtitle">Audio File</div>
                  </div>
                </div>

                <!-- 进度条 -->
                <div class="audio-progress">
                  <div class="progress-bar"
                       @click="seekAudio($event, index)"
                       @mousedown="startDragging($event, index)"
                       @mousemove="onDragging($event, index)"
                       @mouseup="stopDragging"
                       @mouseleave="stopDragging">
                    <div class="progress-track"></div>
                    <div class="progress-current" :style="{ width: getProgress(index) + '%' }"></div>
                    <div class="progress-handle" :style="{ left: getProgress(index) + '%' }"></div>
                  </div>
                  <div class="time-display">
                    <span>{{ getCurrentTime(index) }}</span>
                    <span>{{ getDuration(index) }}</span>
                  </div>
                </div>

                <!-- 控制按钮区 -->
                <div class="audio-controls">
                  <button class="control-btn" @click.stop="handleCopy(index, item.name)">
                    <i class="fas fa-link"></i>
                  </button>

                  <button class="play-btn" @click.stop="togglePlay(index)">
                    <i :class="isPlaying(index) ? 'fas fa-pause' : 'fas fa-play'"></i>
                  </button>

                  <button class="control-btn like-btn" @click.stop="toggleLike(index, item.name)">
                    <i :class="item.metadata.liked ? 'fas fa-heart liked' : 'far fa-heart'"></i>
                  </button>

                  <button class="control-btn" @click.stop="handleDelete(index, item.name)">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>

              <!-- 选中指示器 -->
              <div class="select-indicator" v-if="item.selected">
                <i class="fas fa-check"></i>
              </div>

              <audio
                :ref="'audio-' + index"
                :src="'/file/' + item.name"
                @loadedmetadata="initAudio($event, index)"
                @timeupdate="updateProgress($event, index)"
                @ended="onAudioEnded(index)"
                preload="metadata">
              </audio>
            </el-card>
          </template>
        </div>
        <div class="pagination-container">
          <el-pagination
            background
            layout="prev, pager, next"
            :total="filteredTableData.length"
            :page-size="pageSize"
            @current-change="handlePageChange"
            :current-page.sync="currentPage">
          </el-pagination>
        </div>
        <el-footer class="footer">
          <div>Powered By</div>
          <a href="https://github.com/cf-pages/Telegraph-Image" target="_blank" rel="noopener noreferrer">
            <div><i class="fa-brands fa-github"></i> Telegraph-Image</div>
          </a>
        </el-footer>
      </el-main>
    </el-container>
  </div>
</body>
<!-- Import Vue before Element -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
<!-- Import JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/index.js"></script>
<script>
  new Vue({
    el: '#app',
    data: {
      baseURL: document.location.origin,
      Number: 0,
      tableData: [],
      search: '',
      currentPage: 1,
      pageSize: 15,
      selectedFiles: [],
      sortOption: 'dateDesc',
      showFavorites: false,
      fileType: 'image',
      isDragging: false,
      currentDraggingIndex: null,
      audioStates: {}, // 用于存储音频状态
    },
    computed: {
      filteredTableData() {
        return this.tableData.filter(data => {
          const matchesSearch = !this.search || data.name.toLowerCase().includes(this.search.toLowerCase());
          const matchesFavorites = !this.showFavorites || data.metadata.liked;
          const extension = data.name.split('.').pop().toLowerCase();
          const fileTypes = {
            'image': ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff', 'ico'],
            'video': ['mp4', 'webm', 'ogg', 'avi', 'mov', 'wmv', 'flv', 'mkv'],
            'audio': ['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a', 'wma']
          }
          return matchesSearch && matchesFavorites && fileTypes[this.fileType].includes(extension);
        });
      },
      paginatedTableData() {
        const sortedData = this.sortData(this.filteredTableData);
        const start = (this.currentPage - 1) * this.pageSize;
        const end = start + this.pageSize;
        return sortedData.slice(start, end);
      },
      sortIcon() {
        return this.sortOption === 'dateDesc' ? 'fas  fa-sort-amount-down' : 'fas fa-sort-alpha-up';
      },
      fileTypeIcon() {
        return this.fileType === 'image' ? 'fas fa-image' :
                this.fileType === 'video' ? 'fas fa-video' : 'fas fa-music';
      }
    },
    watch: {
      tableData: {
        handler(newData) {
          this.selectedFiles = newData.filter(file => file.selected);
        },
        deep: true
      },
      sortOption(newOption) {
        localStorage.setItem('sortOption', newOption);
      }
    },
    methods: {
      refreshDashboard() {
        location.reload();
      },
      calculatePageSize() {
        const minPageSize = 15;
        const cardMinWidth = 240; // 卡片最小宽度
        const cardAspectRatio = 3 / 4; // 卡片的高宽比
        const gap = 20; // 卡片间的间隙

        const contentElement = document.querySelector('.content');
        const containerWidth = contentElement ? contentElement.clientWidth : 800;
        const columns = Math.floor(containerWidth / (cardMinWidth + gap));

        const headerElement = document.querySelector('.header-content');
        const headerHeight = headerElement ? headerElement.offsetHeight : 60; // 使用默认值60px
        const containerHeight = window.innerHeight - headerHeight;
        const cardHeight = (containerWidth / columns - gap) * cardAspectRatio;
        const rows = Math.floor(containerHeight / (cardHeight + gap));

        this.pageSize = Math.max(rows * columns, minPageSize);
      },
      updateWindowWidth() {
        this.windowWidth = window.innerWidth;
        this.calculatePageSize();
      },
      toggleSelect(index) {
        this.tableData[index].selected = !this.tableData[index].selected;
      },
      startDragging(event, index) {
        this.isDragging = true;
        this.currentDraggingIndex = index;
        this.updateProgress(event, index);
      },
      stopDragging() {
        this.isDragging = false;
        this.currentDraggingIndex = null;
      },
      onDragging(event, index) {
        if (this.isDragging && this.currentDraggingIndex === index) {
          this.updateProgress(event, index);
        }
      },
      updateProgress(event, index) {
        const audio = this.$refs[`audio-${index}`]?.[0];
        if (!audio) return;

        const rect = event.currentTarget.getBoundingClientRect();
        const percent = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
        audio.currentTime = percent * audio.duration;
      },
      handleUpload() {
        this.$refs.fileInput.click();
      },
      uploadFiles(event) {
        const files = event.target.files;
        if (files.length === 0) return;

        // 过滤文件类型和大小
        const validFiles = [];
        const invalidTypeFiles = [];
        const oversizedFiles = [];

        Array.from(files).forEach(file => {
          const isValidType = file.type.startsWith('image/') || file.type.startsWith('video/') || file.type.startsWith('audio/');
          const isValidSize = file.size <= 5 * 1024 * 1024; // 5MB

          if (!isValidType) {
            invalidTypeFiles.push(file.name);
          } else if (!isValidSize) {
            oversizedFiles.push(file.name);
          } else {
            validFiles.push(file);
          }
        });

        // 显示错误消息
        if (invalidTypeFiles.length > 0) {
          this.$message.error(`以下文件类型不支持: ${invalidTypeFiles.join(', ')}`);
        }
        if (oversizedFiles.length > 0) {
          this.$message.error(`以下文件超过5MB: ${oversizedFiles.join(', ')}`);
        }
        if (validFiles.length === 0) {
          this.$message.info('没有符合条件的文件');
          return;
        }

        console.log("ValidFiles: ", validFiles);
        this.$confirm(`确定要上传这 ${validFiles.length} 个文件吗?`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          // 显示上传进度
          const loadingMessage = this.$message({
            message: '上传中...',
            duration: 0,
            showClose: false,
          });

          const maxConcurrent = 3; // 最大并发数
          let current = 0;
          let successCount = 0;
          let failedUploads = [];

          const uploadNext = () => {
            if (current >= validFiles.length) {
              // 检查是否所有文件都已处理
              if (successCount + failedUploads.length === validFiles.length) {
                loadingMessage.close();
                if (successCount > 0) {
                  this.$message.success(`成功上传 ${successCount} 个文件!`);
                }
                if (failedUploads.length > 0) {
                  this.$message.error(`上传失败: ${failedUploads.join(', ')}`);
                }
                // 刷新文件列表
                this.refreshFileList();
              }
              return;
            }

            const file = validFiles[current];
            current++;

            const formData = new FormData();
            formData.append('file', file);

            fetch(this.baseURL + '/upload', {
              method: 'POST',
              body: formData,
              credentials: 'include'
            }).then(response => {
              if (!response.ok) {
                return response.json().then(errorData => {
                  console.error('Upload error details:', errorData);
                  throw new Error(`上传失败: ${file.name} (${errorData.error || '未知错误'})`);
                });
              }
              return response.json();
            }).then(result => {
              if (Array.isArray(result) && result.length > 0 && result[0].error) {
                // 响应内容中包含错误
                throw new Error(result[0].error || `上传失败: ${file.name}`);
              }

              // 确保 result[0].src 存在
              if (!result[0].src) {
                throw new Error(`上传成功但未返回文件路径: ${file.name}`);
              }

              successCount++;

              // 处理成功上传的文件
              const previewUrl = `${this.baseURL}${result[0].src}`;
              if (result[0].src) {
                fetch(previewUrl, { method: 'GET', credentials: 'include' })
                  .then(response => {
                    if (!response.ok) {
                      console.error(`无法获取文件: ${previewUrl}`);
                    } else {
                      this.tableData.unshift({
                        name: result[0].src.replace(/^\/file\//, ''),
                        selected: false,
                        metadata: { TimeStamp: Date.now() }
                      });
                    }
                  }).catch(error => {
                    console.error(`获取文件时出错: ${previewUrl}`, error);
                  });
              }
            }).catch(error => {
              console.error('Upload error:', error);
              failedUploads.push(`${file.name} (${error.message})`);
            }).finally(() => {
              uploadNext(); // 继续上传下一个文件
            });
          };

          // 启动初始的并发上传任务
          for (let i = 0; i < maxConcurrent && i < validFiles.length; i++) {
            uploadNext();
          }

        }).catch(() => {
          this.$message.info('已取消上传');
        });

        // 清空文件输入，以便可以重复选择相同的文件
        event.target.value = '';
      },
      selectAllInPage() {
        const allSelected = this.paginatedTableData.every(file => file.selected);
        // 如果本页所有图片都已选中，则取消选中
        if (allSelected) {
          this.paginatedTableData.forEach(file => file.selected = false);
        } else {
          this.paginatedTableData.forEach(file => file.selected = true);
        }
      },
      refreshFileList() {
        // 重新获取文件列表
        fetch("./api/manage/list", { method: 'GET', credentials: 'include' })
          .then(response => response.json())
          .then(result => {
            this.tableData = result.map(file => ({ ...file, selected: false }));
            this.updateStats();
            this.sortData(this.tableData);
          })
          .catch(() => this.$message.error('刷新文件列表失败，请检查网络连接'));
      },
      handleDelete(index, key) {
        this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          fetch(`./api/manage/delete/${key}`, { method: 'GET', credentials: 'include' })
            .then(response => response.ok ? this.tableData.splice(index, 1) : Promise.reject())
            .then(() => {
              this.updateStats();
              this.$message.success('删除成功！');
            })
            .catch(() => this.$message.error('删除失败，请检查网络连接'));
        }).catch(() => this.$message.info('已取消删除'));
      },
      handleBatchDelete() {
        this.$confirm('此操作将永久删除这 ' + this.selectedFiles.length + ' 个文件, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          const promises = this.selectedFiles.map(file => fetch(`./api/manage/delete/${file.name}`, { method: 'GET', credentials: 'include' }));

          Promise.all(promises)
            .then(results => {
              results.forEach((response, index) => {
                if (response.ok) {
                  const fileIndex = this.tableData.findIndex(file => file.name === this.selectedFiles[index].name);
                  if (fileIndex !== -1) {
                    this.tableData.splice(fileIndex, 1);
                  }
                }
              });
              this.selectedFiles = [];
              this.updateStats();
              this.$message.success('批量删除成功!');
            })
            .catch(() => this.$message.error('批量删除失败，请检查网络连接'));
        }).catch(() => this.$message.info('已取消批量删除'));
      },
      handleBatchCopy() {
        const links = this.selectedFiles.map(file => `${document.location.origin}/file/${file.name}`).join('\n');
        navigator.clipboard ? navigator.clipboard.writeText(links).then(() => this.$message.success('批量复制链接成功~')) :
          this.copyToClipboardFallback(links);
      },
      copyToClipboardFallback(text) {
        const textarea = document.createElement('textarea');
        document.body.appendChild(textarea);
        textarea.style.position = 'fixed';
        textarea.style.clip = 'rect(0 0 0 0)';
        textarea.style.top = '10px';
        textarea.value = text;
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        this.$message.success('批量复制链接成功~');
      },
      handleLogout() {
        window.location.href = '/';
      },
      handleCopy(index, key) {
        const text = `${this.baseURL}/file/${key}`;
        navigator.clipboard ? navigator.clipboard.writeText(text).then(() => this.$message.success('复制文件链接成功~')) :
          this.copyToClipboardFallback(text);
      },
      handlePageChange(page) {
        this.currentPage = page;
      },
      toggleLike(index, name) {
        console.log(`Toggling like for image: ${name}`);

        // 找到对应文件的索引
        const fileIndex = this.tableData.findIndex(file => file.name === name);
        if (fileIndex === -1) return;

        // 乐观更新收藏状态
        if (this.tableData[fileIndex].metadata.liked === undefined) {
          this.tableData[fileIndex].metadata.liked = false;
        }
        this.tableData[fileIndex].metadata.liked = !this.tableData[fileIndex].metadata.liked;

        // 发送请求更新服务器数据
        var requestOptions = {
          method: 'GET',
          redirect: 'follow',
          credentials: 'include'
        };

        fetch(`./api/manage/toggleLike/${name}`, requestOptions)
          .then(response => response.json())
          .then(result => {
            if (!result.success) {
              // 如果服务器更新失败，将状态还原
              this.tableData[fileIndex].metadata.liked = !this.tableData[fileIndex].metadata.liked;
              this.$message({
                message: '更新收藏状态失败，请稍后重试',
                type: 'error'
              });
            } else {
              this.$message.success(this.tableData[fileIndex].metadata.liked ? '收藏成功' : '取消收藏');
            }
          })
          .catch(error => {
            console.error("An error occurred while synchronizing data with the server", error);
            // 如果服务器响应错误，将状态还原
            this.tableData[fileIndex].metadata.liked = !this.tableData[fileIndex].metadata.liked;
            this.$message({
              message: '同步服务器失败，请检查网络连接',
              type: 'error'
            });
          });
      },
      toggleFavorites() { // 筛选收藏图片
        this.showFavorites = !this.showFavorites;
        this.currentPage = 1;

        this.$message({
          message: this.showFavorites ? '已筛选收藏图片' : '显示全部图片',
          type: 'success',
          duration: 1500
        });
      },
      updateStats() {
        this.Number = this.tableData.length;
      },
      sort(command) {
        this.sortOption = command;
      },
      sortData(data) {
        return this.sortOption === 'nameAsc' ? data.sort((a, b) => a.name.localeCompare(b.name)) :
          data.sort((a, b) => b.metadata.TimeStamp - a.metadata.TimeStamp);
      },
      checkBrokenImages() {
        const loadingMessage = this.$message({
          message: '正在检测失效图片...',
          duration: 0,
          showClose: false,
        });

        let brokenCount = 0;
        const promises = this.tableData.map((item, index) => {
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve({ index, status: 'success' });
            img.onerror = () => {
              brokenCount++;
              this.tableData[index].selected = true;
              resolve({ index, status: 'error' });
            };
            img.src = `${this.baseURL}/file/${item.name}`;
          });
        });

        Promise.all(promises).then(() => {
          loadingMessage.close();
          if (brokenCount > 0) {
            this.$message({
              dangerouslyUseHTMLString: true,
              message: `检测到 ${brokenCount} 张失效图片，已自动选中。<br>您可以使用批量删除功能移除它们。`,
              type: 'warning',
              duration: 5000
            });
          } else {
            this.$message({
              message: '未检测到失效图片',
              type: 'success'
            });
          }
        });
      },
      switchFileType(type) {
        this.fileType = type;
        this.currentPage = 1;
        localStorage.setItem('fileType', type);
        this.$message({
          message: `已切换为 ${this.getFileTypeName(type)} 模式`,
          type: 'success',
          duration: 1500
        });
      },
      getFileTypeTypeName(type) {
        return type === 'image' ? '图片' : type === 'video' ? '视频' : '音频';
      },
      isPlaying(index) {
        const audio = this.$refs[`audio-${index}`]?.[0];
        return audio ? !audio.paused : false;
      },
      togglePlay(index) {
        const audio = this.$refs[`audio-${index}`]?.[0];
        if (!audio) return;

        // 暂停其他正在播放的音频
        Object.keys(this.$refs).forEach(key => {
          if (key.startsWith('audio-') && key !== `audio-${index}`) {
            const otherAudio = this.$refs[key][0];
            if (otherAudio && !otherAudio.paused) {
              otherAudio.pause();
            }
          }
        });

        if (audio.paused) {
          audio.play();
        } else {
          audio.pause();
        }
      },
      initAudio(event, index) {
        const audio = event.target;
        this.$set(this.audioStates, `duration-${index}`, this.formatTime(audio.duration));
      },
      updateProgress(event, index) {
        const audio = event.target;
        this.$set(this.audioStates, `currentTime-${index}`, audio.currentTime);
      },
      onAudioEnded(index) {
        this.$set(this.audioStates, `currentTime-${index}`, 0);
      },
      getCurrentTime(index) {
        const time = this.audioStates[`currentTime-${index}`] || 0;
        return this.formatTime(time);
      },
      getDuration(index) {
        return this.audioStates[`duration-${index}`] || '0:00';
      },
      getProgress(index) {
        const currentTime = this.audioStates[`currentTime-${index}`] || 0;
        const audio = this.$refs[`audio-${index}`]?.[0];
        if (!audio) return 0;
        return (currentTime / audio.duration) * 100 || 0;
      },
      seekAudio(event, index) {
        if (!this.isDragging) {
          this.updateProgress(event, index);
        }
      },
      formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      },
      initPlyr(index) {
        const element = this.$refs[`audio-${index}`][0];
        if (!element) return;

        // 配置 Plyr
        const player = new Plyr(element, {
          controls: [
            'play',
            'progress',
            'current-time',
            'duration',
            'mute',
            'volume'
          ],
          tooltips: { controls: true, seek: true },
          keyboard: { focused: true, global: false }
        });

        // 存储播放器实例
        this.players[index] = player;

        // 在切换音频时暂停其他音频
        player.on('play', () => {
          Object.entries(this.players).forEach(([key, otherPlayer]) => {
            if (key !== index.toString() && otherPlayer.playing) {
              otherPlayer.pause();
            }
          });
        });
      }
    },
    mounted() {
      window.addEventListener('resize', this.calculatePageSize);
      this.updateWindowWidth();
      fetch("./api/manage/check", { method: 'GET', credentials: 'include' })
        .then(response => response.text())
        .then(result => result === "true" ? this.showLogoutButton = true : window.location.href = "./api/manage/login")
        .catch(() => this.$message.error('同步数据时出错，请检查网络连接'));

      fetch("./api/manage/list", { method: 'GET', credentials: 'include' })
        .then(response => response.json())
        .then(result => {
          console.log("result: ", result);
          this.tableData = result.map(file => ({
            ...file,
            selected: false,
            metadata: {
              ...file.metadata,
              liked: file.metadata.liked ?? false
            }
          }));
          this.updateStats();
          const savedSortOption = localStorage.getItem('sortOption');
          if (savedSortOption) {
            this.sortOption = savedSortOption;
          }
          this.sortData(this.tableData);
        })
        .catch(() => this.$message.error('同步数据时出错，请检查网络连接'));

      // 恢复用户偏好的文件类型
      const savedFileType = localStorage.getItem('fileType');
      if (savedFileType) {
        this.switchFileType(savedFileType);
      }
    },
    beforeDestroy() {
      window.removeEventListener('resize', this.calculatePageSize);
      // 清理音频资源
      Object.keys(this.$refs).forEach(key => {
        if (key.startsWith('audio-')) {
          const audio = this.$refs[key][0];
          if (audio) {
            audio.pause();
            audio.src = '';
          }
        }
      });
    }
  });
</script>
</html>